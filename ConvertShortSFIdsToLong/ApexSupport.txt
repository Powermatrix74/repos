test
string last_name = 'Ballato';
string first_name = 'Alessandro';
string Package_LicenseId  = '0501r000000EKD5AAO';
string Permission_Set_License_Id = '0PL1r0000000ewzGAA';
PermissionSetLicenseAssign pm = null;
UserPackageLicense ul = null;
User u = [select id, name from user where Lastname = :last_name and firstname = :first_name];
List<UserPackageLicense> upl = new List<UserPackageLicense>();
List<PermissionSetLicenseAssign> pmla = new List<PermissionSetLicenseAssign>();

if (u != null)
{
    
     boolean userPackageLicenseExists = false;
     boolean PermissionSetLicenseAssignLicenseExists = false;
	 // check for the "old" userPackageLicense
     ul = [select id, UserId from UserPackageLicense where UserId = :u.id and PackageLicenseId = :Package_LicenseId ];
     
     if (ul != null) 
     {
    	userPackageLicenseExists = true;
     }
     else
     {
         system.debug('userpackage CPQ license missing for user: ' + first_name + ' ' + last_name );
     }
     
     // check for the "new" PermissionSetLicenseAssign. if no rows are found this degenerated tool throws an exception!
     try
     {
     	PermissionSetLicenseAssign pm = [select id, permissionsetlicenseid from permissionsetlicenseassign where permissionsetlicenseid =: Permission_Set_License_Id and assigneeid in (select id from user where lastname = :last_name and firstname = :first_name)];
     }
     catch(exception ex)
     {
     }
     if (pm != null)
     {
    	 PermissionSetLicenseAssignLicenseExists = true;    
     }
     else
     {
         system.debug('permissionSetLicenseAssign CPQ license missing for user: ' + first_name + ' ' + last_name );         
     }
     
     // now either create none, one or both of the new licenses
     if (userPackageLicenseExists && PermissionSetLicenseAssignLicenseExists)
     {
         // license exists for both tables, no action needed
         system.debug('CPQ license for user: ' + last_name + ' ' + first_name + ' does exist on both tables.');
     }
     else if(userPackageLicenseExists && !PermissionSetLicenseAssignLicenseExists)
     {
		 // "old" license exists, new license not
         system.debug('no PermissionSetLicenseAssign CPQ license for user: ' + last_name + ' ' + first_name + ' was found.');
     }
     else if (!userPackageLicenseExists && PermissionSetLicenseAssignLicenseExists)
     {
         system.debug('no UserPackageLicenseAssign CPQ license for user: ' + last_name + ' ' + first_name + ' was found.');
     }
     else if (!userPackageLicenseExists && PermissionSetLicenseAssignLicenseExists)
     {
         system.debug('both licenses are missing for user: ' + last_name + ' ' + first_name +'\n' );
     }

}